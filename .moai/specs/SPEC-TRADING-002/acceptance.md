# SPEC-TRADING-002: 인수 조건

## 추적성 태그

| 항목 | 값 |
|------|-----|
| **SPEC ID** | SPEC-TRADING-002 |
| **문서 유형** | Acceptance Criteria |
| **상태** | Pending |

---

## 1. 인수 테스트 시나리오

### AC-001: 매도 체결 시 수익 기록 자동 생성

**Given** Tier 1이 보유된 트레이딩 계좌
  - 전략: Pro1
  - 티커: SOXL
  - Tier 1 매수: 2026-01-15, $61.60, 8주
  - 2026-01-20 종가: $62.50

**When** 2026-01-21에 주문 조회 시 2026-01-20 매도 체결 처리되면

**Then** 시스템은 다음 수익 기록을 생성해야 함:
  | 필드 | 값 |
  |------|-----|
  | tier | 1 |
  | ticker | SOXL |
  | strategy | Pro1 |
  | buyDate | 2026-01-15 |
  | buyPrice | 61.60 |
  | buyQuantity | 8 |
  | sellDate | 2026-01-20 |
  | sellPrice | 62.50 |
  | buyAmount | 492.80 (= 61.60 * 8) |
  | sellAmount | 500.00 (= 62.50 * 8) |
  | profit | 7.20 (= 500.00 - 492.80) |
  | profitRate | 1.46 (= 7.20 / 492.80 * 100) |

---

### AC-002: 다중 티어 동시 매도 시 개별 기록

**Given** Tier 1, 2, 3이 보유된 트레이딩 계좌
  - Tier 1: 2026-01-10, $60.00, 8주
  - Tier 2: 2026-01-12, $58.00, 17주
  - Tier 3: 2026-01-14, $56.00, 27주
  - 매도 목표가 도달 종가: $65.00 (급등)

**When** 세 티어 모두 매도 체결되면

**Then** 시스템은 3개의 개별 수익 기록을 생성해야 함:
  1. Tier 1 수익 기록
     - buyAmount: $480.00
     - sellAmount: $520.00
     - profit: $40.00
  2. Tier 2 수익 기록
     - buyAmount: $986.00
     - sellAmount: $1,105.00
     - profit: $119.00
  3. Tier 3 수익 기록
     - buyAmount: $1,512.00
     - sellAmount: $1,755.00
     - profit: $243.00

---

### AC-003: 손절 매도 시 음수 수익 기록

**Given** Tier 1이 손절 조건에 도달
  - 매수: 2026-01-10, $65.00, 8주
  - 보유일: 10일 (Pro1 손절일)
  - 손절일 종가: $55.00

**When** MOC 손절 매도가 체결되면

**Then** 시스템은 음수 수익 기록을 생성해야 함:
  | 필드 | 값 |
  |------|-----|
  | buyAmount | 520.00 |
  | sellAmount | 440.00 |
  | profit | -80.00 |
  | profitRate | -15.38 |

---

### AC-004: 수익 현황 API 응답

**Given** 다음 수익 기록이 존재
  - 2026-01-15: Tier 1 매도, 수익 $7.20
  - 2026-01-18: Tier 2 매도, 수익 $15.00
  - 2025-12-20: Tier 1 매도, 수익 $10.00

**When** GET /api/trading/accounts/[id]/profits 호출

**Then** 다음 응답이 반환되어야 함:
```json
{
  "accountId": "abc-123",
  "months": [
    {
      "yearMonth": "2026-01",
      "records": [
        { "sellDate": "2026-01-18", "profit": 15.00 },
        { "sellDate": "2026-01-15", "profit": 7.20 }
      ],
      "totalTrades": 2,
      "totalProfit": 22.20
    },
    {
      "yearMonth": "2025-12",
      "records": [
        { "sellDate": "2025-12-20", "profit": 10.00 }
      ],
      "totalTrades": 1,
      "totalProfit": 10.00
    }
  ],
  "grandTotal": {
    "totalTrades": 3,
    "totalProfit": 32.20
  }
}
```

---

### AC-005: UI 월별 접기/펼치기

**Given** 현재 날짜가 2026-01이고, 2025-12와 2026-01 기록이 있음

**When** 수익 현황 테이블을 표시하면

**Then**:
  1. "2026-01 상세 내역" 섹션은 펼쳐진 상태
  2. "2025-12 상세 내역" 섹션은 접힌 상태
  3. 접힌 섹션 클릭 시 펼쳐짐
  4. 펼쳐진 섹션 클릭 시 접힘

---

### AC-006: UI 수익/손실 색상 구분

**Given** 수익 기록 목록에 수익과 손실이 혼재

**When** 테이블에 표시되면

**Then**:
  1. 수익 (profit > 0): 초록색 텍스트 (text-success)
  2. 손실 (profit < 0): 빨간색 텍스트 (text-danger)
  3. 무변동 (profit = 0): 기본 텍스트 색상

---

### AC-007: 월별 소계 표시

**Given** 2026-01월에 3건의 거래 기록
  - 거래 1: buyAmount $500, profit $10
  - 거래 2: buyAmount $1000, profit $25
  - 거래 3: buyAmount $1500, profit -$5

**When** 월별 섹션을 표시하면

**Then** 소계 행에 다음이 표시됨:
  | 항목 | 값 |
  |------|-----|
  | 총 거래 수 | 3건 |
  | 총 매수금액 | $3,000.00 |
  | 총 수익금 | $30.00 |
  | 평균 수익률 | 1.00% (= 30 / 3000 * 100) |

---

### AC-008: 빈 수익 현황 표시

**Given** 계좌에 수익 기록이 없음

**When** 수익 현황 테이블을 표시하면

**Then**:
  1. "아직 매도 체결된 거래가 없습니다." 메시지 표시
  2. 테이블 구조는 표시하지 않음

---

### AC-009: Decimal.js 정밀도 검증

**Given** 다음 거래 데이터
  - 매수가: $63.72
  - 수량: 157주
  - 매도가: $64.99

**When** 수익 계산 시

**Then** Decimal.js로 정확한 값 계산:
  | 계산 | 값 | 검증 |
  |------|-----|------|
  | buyAmount | 10,004.04 | = 63.72 * 157 (버림) |
  | sellAmount | 10,203.43 | = 64.99 * 157 (버림) |
  | profit | 199.39 | = 10203.43 - 10004.04 (반올림) |
  | profitRate | 1.99% | = 199.39 / 10004.04 * 100 (반올림) |

**참고**: JavaScript 기본 연산 시 부동소수점 오차 발생
  - `63.72 * 157` = 10004.039999999999 (오류)
  - Decimal.js 사용 시 = 10004.04 (정확)

---

### AC-010: 인증 및 권한 검증

**Given** 사용자 A의 계좌와 사용자 B의 계좌

**When** 사용자 B가 사용자 A의 수익 현황 조회 시도

**Then**:
  1. 403 Forbidden 응답 반환
  2. 또는 404 Not Found 응답 (계좌 존재 여부 노출 방지)

---

## 2. 품질 게이트

### QG-001: 테스트 커버리지

- [ ] 단위 테스트 커버리지 >= 85%
- [ ] createProfitRecord() 함수 테스트
- [ ] groupProfitsByMonth() 함수 테스트
- [ ] API 엔드포인트 통합 테스트
- [ ] UI 컴포넌트 렌더링 테스트

### QG-002: 성능 기준

- [ ] 수익 조회 API 응답 시간 < 500ms
- [ ] 100건 이상 데이터에서 UI 렌더링 < 100ms
- [ ] 월별 섹션 토글 반응 시간 < 50ms

### QG-003: 데이터 정합성

- [ ] 모든 금액 계산 Decimal.js 사용
- [ ] 소수점 2자리 일관성 유지
- [ ] 수익 기록과 실제 체결 데이터 일치

### QG-004: UI/UX 일관성

- [ ] Bootstrap Solar 테마 색상 일치
- [ ] 기존 Trading 페이지 컴포넌트와 스타일 통일
- [ ] 반응형 레이아웃 (모바일 지원)

---

## 3. 검증 방법

### 3.1 수동 검증 절차

1. **수익 기록 생성 검증**
   ```
   1. 트레이딩 계좌 생성 (Pro1, $10,000)
   2. 사이클 시작 → Tier 1 매수 체결
   3. 매도 조건 충족 시점까지 대기
   4. 매도 체결 확인
   5. DB에서 profit_records 확인
   ```

2. **UI 검증**
   ```
   1. 트레이딩 상세 페이지 열기
   2. 수익 현황 섹션 확인
   3. 월별 접기/펼치기 동작 확인
   4. 수익/손실 색상 확인
   5. 소계 및 총계 확인
   ```

3. **DB 직접 확인**
   ```sql
   -- 수익 기록 확인
   SELECT * FROM profit_records WHERE account_id = ? ORDER BY sell_date DESC;

   -- 월별 통계
   SELECT
     substr(sell_date, 1, 7) as month,
     COUNT(*) as trades,
     SUM(profit) as total_profit
   FROM profit_records
   WHERE account_id = ?
   GROUP BY month
   ORDER BY month DESC;
   ```

### 3.2 자동화 테스트 명령

```bash
# 단위 테스트
npm run test -- --grep "createProfitRecord"
npm run test -- --grep "groupProfitsByMonth"

# API 통합 테스트
npm run test -- --grep "GET /api/trading/accounts/*/profits"

# UI 컴포넌트 테스트
npm run test -- --grep "ProfitStatusTable"
```

---

## 4. Definition of Done

### 필수 항목

- [ ] 모든 인수 조건 시나리오 통과 (AC-001 ~ AC-010)
- [ ] profit_records 테이블 생성 및 마이그레이션
- [ ] 매도 체결 시 수익 기록 자동 생성
- [ ] 수익 조회 API 구현 및 테스트
- [ ] ProfitStatusTable UI 컴포넌트 구현
- [ ] 월별 접기/펼치기 동작 구현
- [ ] Decimal.js 정밀도 검증 통과
- [ ] 코드 리뷰 완료
- [ ] 린트 및 타입 체크 통과

### 선택 항목

- [ ] E2E 테스트 작성
- [ ] 성능 최적화 (페이지네이션)
- [ ] 과거 데이터 마이그레이션 스크립트

---

## 5. 예상 결과 화면

### 수익 현황 테이블 (펼침 상태)

```
┌──────────────────────────────────────────────────────────────────┐
│ 수익 현황                                                          │
├──────────────────────────────────────────────────────────────────┤
│ ▼ 2026-01 상세 내역                                               │
├──────────────────────────────────────────────────────────────────┤
│ 날짜       │ 티어 │ 전략 │ 매수금액   │ 매도금액   │ 수익금   │ 수익률 │
├──────────────────────────────────────────────────────────────────┤
│ 2026-01-20 │ 1    │ Pro1 │ $492.80   │ $500.00   │ $7.20   │ 1.46% │
│ 2026-01-18 │ 2    │ Pro1 │ $986.00   │ $1,001.00 │ $15.00  │ 1.52% │
├──────────────────────────────────────────────────────────────────┤
│ 소계                      │ $1,478.80 │ $1,501.00 │ $22.20  │ 1.50% │
├──────────────────────────────────────────────────────────────────┤
│ ▶ 2025-12 상세 내역 (1건)                                         │
├──────────────────────────────────────────────────────────────────┤
│ 총 수익 요약                                                       │
│ 총 거래: 3건 | 총 매수: $1,978.80 | 총 수익: $32.20 | 평균: 1.63% │
└──────────────────────────────────────────────────────────────────┘
```

---

## 6. 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 1.0 | 2026-01-24 | manager-spec | 초기 인수 조건 작성 |
