# SPEC-DEPLOY-003 인수 조건

## 기능 테스트

### AC-001: Vercel 배포

| 조건 | 기대 결과 | 검증 방법 |
|------|----------|----------|
| GitHub 푸시 | 자동 배포 트리거 | Vercel 대시보드 |
| 빌드 완료 | 성공 상태 | 빌드 로그 |
| 프로덕션 URL | 접근 가능 | 브라우저 테스트 |
| 프리뷰 배포 | PR마다 생성 | PR 코멘트 확인 |

### AC-002: 환경변수

| 조건 | 기대 결과 | 검증 방법 |
|------|----------|----------|
| DATABASE_URL | DB 연결 성공 | API 호출 |
| AUTH_SECRET | 세션 암호화 | 로그인 테스트 |
| CRON_SECRET | 인증 동작 | Cron 테스트 |

### AC-003: Google OAuth

| 조건 | 기대 결과 | 검증 방법 |
|------|----------|----------|
| 로그인 버튼 | Google 리디렉션 | UI 테스트 |
| 인증 완료 | 콜백 처리 | URL 확인 |
| 사용자 생성 | users 테이블 저장 | DB 조회 |
| 세션 생성 | 쿠키 발급 | 브라우저 확인 |

### AC-004: Cron 엔드포인트

| 조건 | 기대 결과 | 검증 방법 |
|------|----------|----------|
| 유효한 토큰 | 200 OK, 업데이트 성공 | curl 테스트 |
| 잘못된 토큰 | 401 Unauthorized | curl 테스트 |
| 토큰 없음 | 401 Unauthorized | curl 테스트 |
| 업데이트 실패 | 500 + 에러 메시지 | 에러 시나리오 |

### AC-005: 프로덕션 데이터 이관 (Local -> Cloud Supabase)

| 조건 | 기대 결과 | 검증 방법 |
|------|----------|----------|
| pg_dump 실행 | Local Supabase 덤프 생성 | 덤프 파일 생성 확인 |
| pg_restore 실행 | Cloud Supabase 복원 완료 | 복원 로그 확인 |
| daily_prices | 전체 이관 | Local vs Cloud row count 비교 |
| daily_metrics | 전체 이관 | Local vs Cloud row count 비교 |
| recommendation_cache | 전체 이관 | Local vs Cloud row count 비교 |
| 데이터 무결성 | 샘플 데이터 일치 | Cloud Supabase에서 랜덤 샘플 비교 |

### AC-006: 자동 업데이트

| 조건 | 기대 결과 | 검증 방법 |
|------|----------|----------|
| 스케줄 시간 | Cron 실행 | Vercel 로그 |
| 가격 업데이트 | 최신 데이터 | DB 조회 |
| 지표 재계산 | 최신 지표 | DB 조회 |

### AC-007: 단위 테스트

| 조건 | 기대 결과 | 검증 방법 |
|------|----------|----------|
| route.test.ts 실행 | 전체 테스트 통과 | `npm test` |
| 인증 테스트 | 토큰 없음/잘못된 토큰 시 401 반환 | 테스트 코드 |
| 성공 시나리오 | 가격/지표 업데이트 후 200 반환 | 테스트 코드 |
| 에러 시나리오 | DB/API 오류 시 500 반환, 내부 메시지 비노출 | 테스트 코드 |
| 엣지 케이스 | 새 데이터 없음, 저장 데이터 없음 처리 | 테스트 코드 |

---

## 비기능 테스트

### 성능

| 항목 | 기준 | 검증 방법 |
|------|------|----------|
| 페이지 로드 | < 3초 | Lighthouse |
| API 응답 | < 1초 | curl 타이밍 |
| Cron 실행 | < 60초 | Vercel 로그 |

### 보안

| 항목 | 기준 | 검증 방법 |
|------|------|----------|
| HTTPS | 강제 적용 | URL 확인 |
| 환경변수 | 노출 없음 | 소스 코드 검토 |
| Cron 인증 | 외부 차단 | 401 테스트 |

### 가용성

| 항목 | 기준 | 검증 방법 |
|------|------|----------|
| 배포 무중단 | 다운타임 없음 | 배포 중 접속 |
| 자동 복구 | 재시작 | 크래시 후 확인 |

---

## 시나리오 테스트

### 시나리오 1: 첫 사용자 여정

1. 프로덕션 URL 접속
2. 홈페이지 확인
3. 로그인 버튼 클릭
4. Google 인증 완료
5. 대시보드 진입
6. 데이터 조회

**기대 결과**: 전 과정 에러 없이 완료

### 시나리오 2: 일일 자동 업데이트

1. 00:30 UTC Cron 실행
2. SOXL 가격 업데이트
3. TQQQ 가격 업데이트
4. 기술지표 재계산
5. 완료 로그 기록

**기대 결과**: 데이터 최신화, 60초 이내 완료

### 시나리오 3: 배포 파이프라인

1. feature 브랜치 푸시
2. 프리뷰 배포 생성
3. PR 생성
4. PR 머지
5. 프로덕션 자동 배포

**기대 결과**: 전 과정 자동화

---

## 롤백 계획

### 배포 롤백

```bash
# Vercel CLI로 이전 배포로 롤백
vercel rollback [deployment-url]
```

### 데이터 롤백

1. Supabase 대시보드에서 Point-in-Time Recovery
2. 또는 백업 SQL 파일로 복원

---

## 산출물 체크리스트

- [x] `vercel.json` 생성 (API Cache-Control 헤더 포함)
- [x] `src/app/api/cron/update-prices/route.ts` 생성 (timingSafeEqual, 증분 업데이트)
- [x] `src/app/api/cron/update-prices/__tests__/route.test.ts` 생성 (493줄, 종합 테스트)
- [x] `scripts/migrate-to-cloud.sh` 이관 스크립트 작성
- [ ] Vercel 환경변수 설정 완료
- [ ] Google OAuth 프로덕션 설정 완료
- [ ] 프로덕션 데이터 이관 완료 (Local -> Cloud)
- [ ] Cron 스케줄 활성화
- [ ] 프로덕션 배포 완료
