# SPEC-TRADING-001: 인수 조건

## 추적성 태그

| 항목 | 값 |
|------|-----|
| **SPEC ID** | SPEC-TRADING-001 |
| **문서 유형** | Acceptance Criteria |
| **상태** | Draft |

---

## 1. 인수 테스트 시나리오

### AC-001: 사이클 시작일 Tier 1 매수 체결

**Given** 빈 트레이딩 계좌가 존재하고
  - 전략: Pro1
  - 시드 캐피털: $10,000
  - 모든 티어가 비어있음 (사이클 시작 상태)
  - 2026-01-22 SOXL 종가: $61.66
  - 2026-01-23 SOXL 종가: $61.60

**When** 2026-01-24에 주문 목록을 조회하면

**Then** 시스템은 다음을 수행해야 함:
  1. 2026-01-23의 Tier 1 매수 주문이 체결됨
     - 매수 지정가: $61.65 (= floor(61.66 * 0.9999, 2))
     - 체결 조건: $61.60 <= $61.65 (만족)
     - 체결가: $61.60
     - 수량: 8주 (= floor(500 / 61.65))
  2. tier_holdings 테이블이 업데이트됨
     - tier: 1
     - shares: 8
     - buyPrice: 61.60
     - buyDate: 2026-01-23
     - sellTargetPrice: $61.60 (= floor(61.60 * 1.0001, 2))
  3. 2026-01-24 주문이 생성됨
     - Tier 1 매도 (LOC): $61.60, 8주
     - Tier 2 매수 (LOC): 전일 종가 기준 계산

---

### AC-002: 보유 현황 테이블 표시

**Given** Tier 1이 체결된 상태
  - 체결일: 2026-01-23
  - 체결가: $61.60
  - 수량: 8주

**When** 2026-01-24에 트레이딩 화면을 열면

**Then** 보유 현황 테이블에 다음이 표시되어야 함:
  | 티어 | 수량 | 매수가 | 매수일 | 매도 목표가 | 보유일 |
  |------|-----|--------|--------|-----------|-------|
  | 1 | 8 | $61.60 | 2026-01-23 | $61.60 | 1 |

---

### AC-003: 당일 주문 테이블 표시

**Given** Tier 1이 체결된 상태

**When** 2026-01-24에 주문 목록을 조회하면

**Then** 주문 테이블에 다음이 표시되어야 함:
  | 티어 | 유형 | 방식 | 지정가 | 수량 | 체결 |
  |------|-----|-----|-------|-----|-----|
  | 1 | SELL | LOC | $61.60 | 8 | - |
  | 2 | BUY | LOC | (계산값) | (계산값) | - |

---

### AC-004: 종가 데이터 없을 때 체결 안 함

**Given** 이전 거래일의 종가 데이터가 DB에 없음

**When** 오늘 주문 목록을 조회하면

**Then**:
  1. 이전 거래일 주문은 체결되지 않음 (executed: false 유지)
  2. 오늘 주문은 정상 생성됨
  3. 에러 없이 응답 반환됨

---

### AC-005: 이미 체결된 주문 중복 처리 방지

**Given** 이전 거래일 주문이 이미 체결됨 (executed: true)

**When** 다시 주문 목록을 조회하면

**Then**:
  1. 체결 로직이 다시 실행되지 않음
  2. tier_holdings가 변경되지 않음
  3. 동일한 결과 반환됨

---

### AC-006: Pro1 전략 전체 사이클 검증

**Given** Pro1 전략 계좌
  - 시드 캐피털: $10,000
  - 티어 비율: [5%, 10%, 15%, 20%, 25%, 25%]
  - 매수 임계값: -0.01%
  - 매도 임계값: +0.01%

**When** 다음 가격 시퀀스로 트레이딩 시뮬레이션:
  - Day 1: 종가 $100.00 → Tier 1 매수 주문 생성
  - Day 2: 종가 $99.99 → Tier 1 매수 체결 ($100.00 * 0.9999 = $99.99 이하)
  - Day 3: 종가 $100.00 → Tier 1 매도 체결? ($99.99 * 1.0001 = $100.00 이상)

**Then**:
  1. Day 2: Tier 1 매수 체결 (8주 @ $99.99)
  2. Day 3: Tier 1 매도 체결 (8주 @ $100.00)
  3. 수익 실현: 8 * ($100.00 - $99.99) = $0.08

---

### AC-007: 손절일 MOC 매도

**Given** Tier 1 보유 상태
  - 매수일: 2026-01-10
  - 손절일: 10일 (Pro1)

**When** 2026-01-24 (보유 10일차)에 주문 생성

**Then**:
  1. Tier 1 매도 주문이 MOC로 생성됨
  2. 지정가 대신 시장가(종가)로 설정됨
  3. 체결 시 무조건 종가로 체결됨

---

## 2. 품질 게이트

### QG-001: 테스트 커버리지

- [ ] 단위 테스트 커버리지 >= 85%
- [ ] 통합 테스트 시나리오 모두 통과
- [ ] E2E 테스트 통과

### QG-002: 성능 기준

- [ ] 주문 조회 API 응답 시간 < 500ms
- [ ] 체결 처리 시간 < 100ms

### QG-003: 데이터 일관성

- [ ] 체결 후 tier_holdings 즉시 업데이트됨
- [ ] 주문 상태와 holdings 상태 일치
- [ ] 중복 체결 없음

---

## 3. 검증 방법

### 3.1 수동 검증 절차

1. **사이클 시작 검증**
   ```
   1. 새 트레이딩 계좌 생성 (Pro1, $10,000)
   2. 브라우저에서 계좌 상세 페이지 열기
   3. 보유 현황 테이블: Tier 1 데이터 확인
   4. 주문 테이블: Tier 1 SELL + Tier 2 BUY 확인
   ```

2. **DB 직접 확인**
   ```sql
   -- 보유 현황 확인
   SELECT * FROM tier_holdings WHERE account_id = ?;

   -- 주문 내역 확인
   SELECT * FROM daily_orders WHERE account_id = ? ORDER BY date DESC;
   ```

### 3.2 자동화 테스트 명령

```bash
# 단위 테스트
npm run test -- --grep "processPreviousDayExecution"

# 통합 테스트
npm run test -- --grep "Trading Cycle Flow"

# E2E 테스트 (있는 경우)
npm run test:e2e -- --grep "trading"
```

---

## 4. Definition of Done

- [ ] 모든 인수 조건 시나리오 통과
- [ ] 단위 테스트 작성 및 통과
- [ ] 통합 테스트 작성 및 통과
- [ ] 코드 리뷰 완료
- [ ] 문서 업데이트 (필요 시)
- [ ] 레퍼런스 사이트와 동일한 결과 확인
  - Holdings: Tier 1 = 146주, $61.6, 2026-01-23, 1일
  - Orders: Tier 1 SELL $62.83 + Tier 2 BUY $61.53

---

## 5. 변경 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 1.0 | 2026-01-24 | manager-spec | 초기 인수 조건 작성 |
