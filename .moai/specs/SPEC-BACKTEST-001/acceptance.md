# SPEC-BACKTEST-001 수용 기준

## 메타데이터

| 항목 | 내용 |
|------|------|
| **SPEC ID** | SPEC-BACKTEST-001 |
| **제목** | 백테스트 엔진 수용 기준 |
| **생성일** | 2026-01-16 |

---

## 1. 기능 테스트 시나리오

### 1.1 LOC 매수 주문 계산

#### TC-001: 매수 지정가 계산

```gherkin
Feature: LOC 매수 지정가 계산
  전일 종가와 매수 기준을 사용하여 LOC 매수 지정가를 계산한다.

  Scenario: Pro2 전략 매수 지정가 계산
    Given 전일 종가가 $25.00이다
    And 매수 기준이 -0.01% (-0.0001)이다
    When LOC 매수 지정가를 계산한다
    Then 지정가는 $25.00 × 0.9999 = $24.9975이다
    And 소수점 둘째자리 버림 적용 후 $24.99이다

  Scenario: Pro3 전략 매수 지정가 계산
    Given 전일 종가가 $30.50이다
    And 매수 기준이 -0.10% (-0.001)이다
    When LOC 매수 지정가를 계산한다
    Then 지정가는 $30.50 × 0.999 = $30.4695이다
    And 소수점 둘째자리 버림 적용 후 $30.46이다
```

#### TC-002: 매수 수량 계산

```gherkin
Feature: LOC 매수 수량 계산
  티어 금액과 매수 지정가를 사용하여 매수 수량을 계산한다.

  Scenario: Pro2 전략 티어1 매수 수량 계산
    Given 티어1 투자금이 $1,000이다
    And 매수 지정가가 $24.99이다
    When 매수 수량을 계산한다
    Then 수량은 $1,000 ÷ $24.99 = 40.016주이다
    And 정수 버림 적용 후 40주이다

  Scenario: 소액 티어 매수 수량 계산
    Given 티어 투자금이 $500이다
    And 매수 지정가가 $33.33이다
    When 매수 수량을 계산한다
    Then 수량은 $500 ÷ $33.33 = 15.00주이다
    And 정수 버림 적용 후 15주이다
```

### 1.2 LOC 매수 체결 판정

#### TC-003: 매수 체결 조건

```gherkin
Feature: LOC 매수 체결 판정
  당일 종가가 매수 지정가 이하일 때 체결된다.

  Scenario: 매수 체결 성공 (종가 < 지정가)
    Given 매수 지정가가 $24.99이다
    And 당일 종가가 $24.85이다
    When 체결 여부를 판정한다
    Then 매수가 체결된다
    And 체결 가격은 당일 종가 $24.85이다

  Scenario: 매수 체결 성공 (종가 = 지정가)
    Given 매수 지정가가 $24.99이다
    And 당일 종가가 $24.99이다
    When 체결 여부를 판정한다
    Then 매수가 체결된다
    And 체결 가격은 당일 종가 $24.99이다

  Scenario: 매수 미체결 (종가 > 지정가)
    Given 매수 지정가가 $24.99이다
    And 당일 종가가 $25.10이다
    When 체결 여부를 판정한다
    Then 매수가 체결되지 않는다
```

### 1.3 LOC 매도 주문 계산

#### TC-004: 매도 지정가 계산

```gherkin
Feature: LOC 매도 지정가 계산
  해당 티어의 매수 체결가와 매도 기준을 사용하여 매도 지정가를 계산한다.

  Scenario: Pro2 전략 매도 지정가 계산
    Given 티어1 매수 체결가가 $24.85이다
    And 매도 기준이 +1.50% (0.015)이다
    When LOC 매도 지정가를 계산한다
    Then 지정가는 $24.85 × 1.015 = $25.22275이다
    And 소수점 둘째자리 버림 적용 후 $25.22이다

  Scenario: Pro1 전략 매도 지정가 계산 (낮은 기준)
    Given 티어 매수 체결가가 $30.00이다
    And 매도 기준이 +0.01% (0.0001)이다
    When LOC 매도 지정가를 계산한다
    Then 지정가는 $30.00 × 1.0001 = $30.003이다
    And 소수점 둘째자리 버림 적용 후 $30.00이다
```

### 1.4 LOC 매도 체결 판정

#### TC-005: 매도 체결 조건

```gherkin
Feature: LOC 매도 체결 판정
  당일 종가가 매도 지정가 이상일 때 체결된다.

  Scenario: 매도 체결 성공 (종가 > 지정가)
    Given 매도 지정가가 $25.22이다
    And 당일 종가가 $25.30이다
    When 체결 여부를 판정한다
    Then 매도가 체결된다
    And 체결 가격은 당일 종가 $25.30이다

  Scenario: 매도 체결 성공 (종가 = 지정가)
    Given 매도 지정가가 $25.22이다
    And 당일 종가가 $25.22이다
    When 체결 여부를 판정한다
    Then 매도가 체결된다
    And 체결 가격은 당일 종가 $25.22이다

  Scenario: 매도 미체결 (종가 < 지정가)
    Given 매도 지정가가 $25.22이다
    And 당일 종가가 $25.10이다
    When 체결 여부를 판정한다
    Then 매도가 체결되지 않는다
```

### 1.5 손절일 MOC 매도

#### TC-006: 손절일 처리

```gherkin
Feature: 손절일 MOC 매도
  손절일에 도달하면 보유 티어 전량을 무조건 종가에 매도한다.

  Scenario: Pro2 전략 10일차 손절
    Given 현재 사이클 시작 후 10일이 경과했다
    And Pro2 전략의 손절일은 10일이다
    And 티어1 (40주), 티어2 (59주)를 보유 중이다
    When 손절일 체크를 수행한다
    Then MOC 매도 주문이 실행된다
    And 99주 전량이 당일 종가에 매도된다
    And 현재 사이클이 종료된다

  Scenario: Pro3 전략 12일차 손절
    Given 현재 사이클 시작 후 12일이 경과했다
    And Pro3 전략의 손절일은 12일이다
    And 티어1~4를 보유 중이다
    When 손절일 체크를 수행한다
    Then MOC 매도 주문이 실행된다
    And 보유 주식 전량이 당일 종가에 매도된다
```

### 1.6 사이클 관리

#### TC-007: 사이클 종료 및 시작

```gherkin
Feature: 사이클 관리
  모든 보유 티어가 매도되면 사이클이 종료되고 새 사이클이 시작된다.

  Scenario: 정상 매도로 사이클 종료
    Given 티어1, 티어2, 티어3를 보유 중이다
    And 당일 종가가 모든 티어의 매도 지정가 이상이다
    When 매도 체결 처리를 수행한다
    Then 모든 티어가 매도된다
    And 현재 사이클이 종료된다
    And 새로운 사이클이 시작된다
    And 사이클 번호가 1 증가한다

  Scenario: 부분 매도 (사이클 유지)
    Given 티어1, 티어2, 티어3를 보유 중이다
    And 당일 종가가 티어3의 매도 지정가만 충족한다
    When 매도 체결 처리를 수행한다
    Then 티어3만 매도된다
    And 티어1, 티어2는 여전히 보유 중이다
    And 현재 사이클이 유지된다
```

#### TC-007a: 풀복리 - 수익 발생 시 재투자

```gherkin
Feature: 풀복리 수익 재투자
  사이클 종료 시 수익이 발생하면 다음 사이클의 초기 투자금에 수익이 더해진다.

  Scenario: 수익 발생 후 다음 사이클 투자금 증가
    Given 사이클 1의 초기 투자금이 $10,000이다
    And 티어1~3을 매수하여 총 $3,000을 투자했다
    And 매도 시점에 총 매도금액이 $3,150이다 (수익 $150)
    When 모든 티어가 매도되어 사이클 1이 종료된다
    Then 사이클 2의 초기 투자금은 $10,150이다
    And 사이클 2의 각 티어 금액은 $10,150 기준으로 재계산된다

  Scenario: Pro2 전략 풀복리 티어 금액 재계산
    Given 사이클 2의 총 투자금이 $10,150이다
    And Pro2 전략의 티어 비율은 10%, 15%, 20%, 25%, 20%, 10%이다
    When 사이클 2가 시작된다
    Then 티어1 금액은 $10,150 × 10% = $1,015이다
    And 티어2 금액은 $10,150 × 15% = $1,522.50이다
    And 티어3 금액은 $10,150 × 20% = $2,030이다
```

#### TC-007b: 풀복리 - 손실 발생 시 투자금 감소

```gherkin
Feature: 풀복리 손실 반영
  사이클 종료 시 손실이 발생하면 다음 사이클의 초기 투자금에서 손실이 차감된다.

  Scenario: 손절로 인한 손실 후 다음 사이클 투자금 감소
    Given 사이클 1의 초기 투자금이 $10,000이다
    And 손절일에 MOC 매도로 총 $9,500를 회수했다 (손실 $500)
    When 사이클 1이 종료된다
    Then 사이클 2의 초기 투자금은 $9,500이다
    And 사이클 2의 각 티어 금액은 $9,500 기준으로 재계산된다

  Scenario: 연속 손실 시 투자금 누적 감소
    Given 사이클 1에서 $500 손실이 발생했다
    And 사이클 2의 초기 투자금이 $9,500이다
    And 사이클 2에서 $300 손실이 발생했다
    When 사이클 2가 종료된다
    Then 사이클 3의 초기 투자금은 $9,200이다
```

### 1.7 예비 티어(7티어) 처리

#### TC-008: 풀티어 상태에서 예비 티어 사용

```gherkin
Feature: 예비 티어 처리
  티어 1~6이 모두 체결된 풀티어 상태에서 추가 하락 시 예비 티어를 사용한다.

  Scenario: 예비 티어 매수 조건 충족
    Given 초기 투자금이 $10,000이다
    And 티어 1~6이 모두 체결되어 $9,850이 사용되었다
    And 잔여 예수금이 $150이다
    And 전일 종가가 $20.00이다
    And 당일 종가가 $19.95이다 (하락)
    And 매수 지정가($19.99) 이하이다
    When 매수 체결 처리를 수행한다
    Then 예비 티어(7티어)로 $150 전액 매수가 실행된다
    And 매수 수량은 floor($150 / $19.99) = 7주이다
    And 체결 가격은 당일 종가 $19.95이다

  Scenario: 예비 티어 미발동 - 잔여 예수금 없음
    Given 티어 1~6이 모두 체결되었다
    And 잔여 예수금이 $0이다
    And 당일 추가 하락이 발생했다
    When 매수 체결 처리를 수행한다
    Then 예비 티어 매수가 실행되지 않는다

  Scenario: 예비 티어 미발동 - 풀티어 아님
    Given 티어 1~5만 체결되었다 (티어 6 미체결)
    And 잔여 예수금이 $500이다
    And 당일 추가 하락이 발생했다
    When 매수 체결 처리를 수행한다
    Then 예비 티어 매수가 실행되지 않는다
    And 티어 6 매수가 시도된다
```

#### TC-008a: 예비 티어 매도

```gherkin
Feature: 예비 티어 매도
  예비 티어도 다른 티어와 동일한 매도 조건을 적용한다.

  Scenario: 예비 티어 정상 매도
    Given 예비 티어(7티어)를 $19.95에 7주 보유 중이다
    And 매도 기준이 +1.50%이다
    And 매도 지정가는 floor($19.95 × 1.015) = $20.24이다
    And 당일 종가가 $20.30이다
    When 매도 체결 처리를 수행한다
    Then 예비 티어 7주가 $20.30에 매도된다

  Scenario: 예비 티어 손절일 MOC 매도
    Given 예비 티어(7티어)를 포함하여 티어 1~7을 보유 중이다
    And 손절일(10일 또는 12일)에 도달했다
    When 손절 처리를 수행한다
    Then 예비 티어를 포함한 모든 티어가 MOC 매도된다
    And 사이클이 종료된다
```

---

## 2. 검증 테스트 시나리오

### 2.1 기준값 일치 검증

#### TC-009: Pro1 전략 검증

```gherkin
Feature: Pro1 전략 백테스트 결과 검증
  Pro1 전략의 백테스트 결과가 기준값과 일치해야 한다.

  Scenario: Pro1 전략 2025년 백테스트
    Given 티커가 "SOXL"이다
    And 전략이 "Pro1"이다
    And 시작일이 "2025-01-02"이다
    And 종료일이 "2025-12-19"이다
    And 초기 투자금이 $10,000이다
    When 백테스트를 실행한다
    Then 최종 자산은 $13,472 ± 1%이다
    And 수익률은 34.72% ± 1%p이다
    And MDD는 -18.7% ± 1%p이다
```

#### TC-010: Pro2 전략 검증

```gherkin
Feature: Pro2 전략 백테스트 결과 검증
  Pro2 전략의 백테스트 결과가 기준값과 일치해야 한다.

  Scenario: Pro2 전략 2025년 백테스트
    Given 티커가 "SOXL"이다
    And 전략이 "Pro2"이다
    And 시작일이 "2025-01-02"이다
    And 종료일이 "2025-12-19"이다
    And 초기 투자금이 $10,000이다
    When 백테스트를 실행한다
    Then 최종 자산은 $13,029 ± 1%이다
    And 수익률은 30.29% ± 1%p이다
    And MDD는 -38.3% ± 1%p이다
```

#### TC-011: Pro3 전략 검증

```gherkin
Feature: Pro3 전략 백테스트 결과 검증
  Pro3 전략의 백테스트 결과가 기준값과 일치해야 한다.

  Scenario: Pro3 전략 2025년 백테스트
    Given 티커가 "SOXL"이다
    And 전략이 "Pro3"이다
    And 시작일이 "2025-01-02"이다
    And 종료일이 "2025-12-19"이다
    And 초기 투자금이 $10,000이다
    When 백테스트를 실행한다
    Then 최종 자산은 $14,120 ± 1%이다
    And 수익률은 41.2% ± 1%p이다
    And MDD는 -44.4% ± 1%p이다
```

---

## 3. API 테스트 시나리오

### 3.1 정상 요청 처리

#### TC-012: 백테스트 API 성공 응답

```gherkin
Feature: 백테스트 API 정상 처리
  유효한 요청에 대해 백테스트 결과를 반환한다.

  Scenario: Pro2 전략 백테스트 API 호출
    Given API 엔드포인트 "POST /api/backtest"
    When 다음 요청을 전송한다:
      """
      {
        "ticker": "SOXL",
        "strategy": "Pro2",
        "startDate": "2025-01-02",
        "endDate": "2025-12-19",
        "initialCapital": 10000
      }
      """
    Then 응답 상태 코드는 200이다
    And 응답 본문에 "success": true가 포함된다
    And 응답 본문에 "data.finalAsset"이 숫자로 포함된다
    And 응답 본문에 "data.returnRate"이 숫자로 포함된다
    And 응답 본문에 "data.mdd"가 음수로 포함된다
```

### 3.2 입력 검증

#### TC-013: 잘못된 전략 이름

```gherkin
Feature: API 입력 검증
  잘못된 입력에 대해 적절한 에러 응답을 반환한다.

  Scenario: 지원하지 않는 전략 이름
    Given API 엔드포인트 "POST /api/backtest"
    When 다음 요청을 전송한다:
      """
      {
        "ticker": "SOXL",
        "strategy": "Pro4",
        "startDate": "2025-01-02",
        "endDate": "2025-12-19"
      }
      """
    Then 응답 상태 코드는 400이다
    And 응답 본문에 에러 메시지가 포함된다
```

#### TC-014: 잘못된 날짜 형식

```gherkin
Feature: API 날짜 검증
  잘못된 날짜 형식에 대해 에러를 반환한다.

  Scenario: 유효하지 않은 날짜 형식
    Given API 엔드포인트 "POST /api/backtest"
    When 다음 요청을 전송한다:
      """
      {
        "ticker": "SOXL",
        "strategy": "Pro2",
        "startDate": "01-02-2025",
        "endDate": "2025-12-19"
      }
      """
    Then 응답 상태 코드는 400이다
    And 응답 본문에 날짜 형식 관련 에러 메시지가 포함된다
```

#### TC-015: 음수 초기 자본

```gherkin
Feature: API 자본금 검증
  음수 또는 0의 초기 자본에 대해 에러를 반환한다.

  Scenario: 음수 초기 자본
    Given API 엔드포인트 "POST /api/backtest"
    When 다음 요청을 전송한다:
      """
      {
        "ticker": "SOXL",
        "strategy": "Pro2",
        "startDate": "2025-01-02",
        "endDate": "2025-12-19",
        "initialCapital": -1000
      }
      """
    Then 응답 상태 코드는 400이다
    And 응답 본문에 자본금 관련 에러 메시지가 포함된다
```

---

## 4. 성능 테스트 시나리오

### 4.1 응답 시간 검증

#### TC-016: 1년치 데이터 백테스트 성능

```gherkin
Feature: 백테스트 성능
  1년치 데이터에 대한 백테스트가 5초 이내에 완료되어야 한다.

  Scenario: 1년 백테스트 성능 검증
    Given 티커가 "SOXL"이다
    And 시작일이 "2025-01-02"이다
    And 종료일이 "2025-12-31"이다 (약 252 거래일)
    When 백테스트를 실행하고 시간을 측정한다
    Then 실행 시간은 5초 이내이다
```

---

## 5. 엣지 케이스 테스트

### 5.1 경계 조건

#### TC-017: 첫 거래일 처리

```gherkin
Feature: 첫 거래일 처리
  백테스트 첫 거래일에는 전일 종가가 없으므로 매수를 시도하지 않는다.

  Scenario: 첫 거래일 스킵
    Given 백테스트 시작일이 "2025-01-02"이다
    When 첫 거래일을 처리한다
    Then 해당 일에는 매수 주문이 발생하지 않는다
    And 두 번째 거래일부터 매수 조건을 체크한다
```

#### TC-018: 데이터 누락 처리

```gherkin
Feature: 데이터 누락 처리
  요청 기간 내 데이터가 없는 경우 에러를 반환한다.

  Scenario: 데이터 없는 기간 요청
    Given 데이터베이스에 "2020-01-01" ~ "2020-12-31" 데이터가 없다
    When 해당 기간으로 백테스트를 요청한다
    Then 에러 응답이 반환된다
    And 에러 메시지에 "데이터 없음" 관련 내용이 포함된다
```

#### TC-019: 동일 날짜 시작/종료

```gherkin
Feature: 동일 날짜 처리
  시작일과 종료일이 같은 경우 최소 결과를 반환한다.

  Scenario: 단일 거래일 백테스트
    Given 시작일이 "2025-06-15"이다
    And 종료일이 "2025-06-15"이다
    When 백테스트를 실행한다
    Then 초기 자본과 동일한 최종 자산이 반환된다
    And 수익률은 0%이다
```

---

## 6. 품질 게이트 (Definition of Done)

### 6.1 코드 품질

- [ ] 모든 TypeScript 컴파일 에러 없음
- [ ] ESLint 경고 0개
- [ ] Prettier 포맷팅 적용

### 6.2 테스트 커버리지

- [ ] 단위 테스트 커버리지 85% 이상
- [ ] 모든 EARS 요구사항에 대응하는 테스트 케이스 존재
- [ ] TC-009, TC-010, TC-011 기준값 검증 테스트 통과

### 6.3 문서화

- [ ] 모든 public 함수에 JSDoc 주석
- [ ] API 엔드포인트 사용법 문서화
- [ ] 전략 매개변수 설명 포함

### 6.4 통합

- [ ] 기존 데이터베이스 모듈과 정상 연동
- [ ] Next.js App Router와 정상 통합
- [ ] 프론트엔드 연동 테스트 통과

---

## 7. 추적성 매트릭스

| 요구사항 ID | 테스트 케이스 | 검증 항목 |
|-------------|--------------|----------|
| REQ-001 | TC-001, TC-004 | 전략 매개변수 적용 |
| REQ-002 | TC-001, TC-002 | LOC 매수 계산 |
| REQ-003 | TC-003 | LOC 매수 체결 |
| REQ-004 | TC-004 | LOC 매도 계산 |
| REQ-005 | TC-005 | LOC 매도 체결 |
| REQ-006 | TC-006 | MOC 손절 매도 |
| REQ-007 | TC-007, TC-007a, TC-007b | 사이클 관리 및 풀복리 |
| REQ-008 | TC-008, TC-008a | 예비 티어(7티어) 처리 |
| REQ-009 | TC-009, TC-010, TC-011 | 성과 지표 |
| REQ-010 | TC-016 | 성능 요구사항 |
| REQ-011 | TC-009, TC-010, TC-011 | 기준값 일치 |
| REQ-012 | TC-012, TC-013, TC-014, TC-015 | API 기능 |
