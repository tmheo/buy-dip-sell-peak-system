# 떨사오팔 Pro (Buy Dip Sell Peak Pro)

## 프로젝트 개요

떨사오팔 Pro는 3배 레버리지 ETF(SOXL, TQQQ) 트레이딩 전략을 위한 CLI 및 웹 기반 백테스팅, 전략 추천, 데이터 관리 시스템입니다. Yahoo Finance에서 일별 가격 데이터를 다운로드하여 Supabase(PostgreSQL) 또는 로컬 SQLite 데이터베이스에 저장하고, 다양한 기간의 데이터를 조회 및 분석할 수 있습니다.

### 프로젝트명 유래

"떨사오팔"은 "떨어질 때 사고, 오를 때 팔아라"의 줄임말로, 저점 매수-고점 매도 전략의 핵심 철학을 담고 있습니다.

---

## 대상 사용자

### 주요 타겟

- **개인 투자자**: 레버리지 ETF 투자에 관심 있는 개인 트레이더
- **퀀트 투자자**: 데이터 기반 투자 전략을 연구하는 투자자
- **백테스팅 연구자**: 과거 데이터를 활용한 전략 검증이 필요한 사용자

### 사용자 요구사항

- 장기간의 레버리지 ETF 가격 데이터 확보
- 클라우드 및 로컬 환경에서의 빠른 데이터 조회
- 증분 업데이트를 통한 최신 데이터 유지
- CLI 및 웹 UI 기반의 간편한 데이터 관리
- AI 기반 최적 전략 추천

---

## 지원 티커

| 티커 | 정식 명칭 | 상장일 | 설명 |
|------|----------|--------|------|
| **SOXL** | Direxion Daily Semiconductor Bull 3X Shares | 2010-03-11 | 반도체 섹터 3배 레버리지 |
| **TQQQ** | ProShares UltraPro QQQ | 2010-02-09 | 나스닥 100 3배 레버리지 |

---

## 핵심 기능

### 1. 데이터 수집

- **Yahoo Finance API 연동**: 신뢰할 수 있는 데이터 소스에서 가격 정보 수집
- **전체 히스토리 다운로드**: 티커 상장일부터 현재까지 모든 데이터 한 번에 수집
- **증분 업데이트**: 마지막 저장 날짜 이후의 신규 데이터만 효율적으로 다운로드

### 2. 데이터 저장

- **Supabase PostgreSQL**: 클라우드 기반 데이터베이스로 어디서든 접근 가능
- **Drizzle ORM**: 타입 안전한 ORM으로 데이터베이스 스키마 관리 및 쿼리 빌딩
- **트랜잭션 처리**: 대량 데이터 삽입 시 원자성 보장
- **Connection Pooling**: Supabase Connection Pooler 활용으로 성능 최적화

### 3. 데이터 조회

- **날짜 범위 조회**: 특정 기간의 가격 데이터 검색
- **인덱스 최적화**: (ticker, date) 복합 인덱스로 빠른 조회
- **멀티 티커 지원**: 여러 티커의 데이터 독립적으로 관리

### 4. 안정성

- **자동 재시도**: Rate Limit (429 에러) 발생 시 지수 백오프로 최대 3회 재시도
- **에러 처리**: 명확한 에러 메시지와 적절한 종료 코드
- **데이터 무결성**: UNIQUE 제약 조건으로 중복 데이터 방지

### 5. 웹 UI 대시보드

- **전략 정보 페이지**: 떨사오팔 Pro 전략 설명 및 사용법 안내
- **백테스트 폼**: 기간 및 종목 선택을 통한 백테스트 파라미터 입력
- **전략 추천 페이지**: 기준일 기반 최적 전략 추천 (유사 구간 분석)
- **백테스트 추천 페이지**: 사이클별 추천 전략을 적용한 동적 백테스트
- **반응형 디자인**: 데스크톱, 태블릿, 모바일 화면 최적화
- **다크 테마**: Bootswatch Solar 테마 기반의 눈 편한 UI

### 6. 사용자 인증 및 계정 관리

- **Google OAuth 로그인**: NextAuth.js v5 기반의 소셜 로그인
- **마이페이지**: 사용자 프로필 정보 조회 (이름, 이메일, 프로필 이미지, 가입일)
- **회원 탈퇴**: 확인 모달을 통한 계정 삭제 기능 (CASCADE 삭제로 관련 데이터 정리)

### 7. 트레이딩 계좌 관리

- **계좌 CRUD**: 트레이딩 계좌 생성, 조회, 수정, 삭제 기능
- **티어 고정 방식**: 7개 티어(1~6 + 예비티어7) 자동 생성 및 관리
- **티어 보유현황**: 티어별 보유 주식 수량, 매수가, 보유일수 표시
- **당일 주문 자동 생성**: LOC(지정가) 매수/매도, MOC(시장가) 손절 주문 생성
- **주문 체결 처리**: 종가 기준 체결 여부 판정 및 티어 업데이트
- **손절 처리**: 보유일 >= 손절일 시 MOC 주문으로 전량 청산
- **수익 기록 관리**: 매도 체결 시 수익 기록 저장 및 조회
- **사이클 보호**: 사이클 진행 중 계좌 설정 변경 방지

### 8. 전략 추천 엔진

- **유사 구간 분석**: 5개 기술적 지표(MA기울기, 이격도, RSI, ROC, 변동성)를 기반으로 과거 유사 구간 검색
- **지수 감쇠 유사도**: 지표별 가중치와 허용오차를 적용한 유사도 계산
- **전략 점수 계산**: 유사 구간에서 20 거래일 성과(수익률, MDD) 기반 점수 산출
- **정배열/역배열 필터**: 기준일과 동일한 MA 배열 상태만 검색
- **추천 캐시**: `recommendation_cache` 테이블로 성능 최적화

### 9. RSI 다이버전스 및 전략 하향 규칙

- **RSI 베어리시 다이버전스 탐지**: 25 거래일 윈도우에서 가격은 상승/횡보하나 RSI가 하락하는 패턴 감지
- **SOXL 전용 하향 규칙**: 특정 조건 충족 시 전략을 한 단계 보수적으로 하향 (Pro3→Pro2→Pro1)
  - 조건 1: RSI >= 60 AND 역배열 (MA20 < MA60)
  - 조건 2: RSI 다이버전스 AND 이격도 < 120% AND 기준일 RSI >= 60
- **정배열 시 Pro1 제외 규칙**: 정배열 상태에서는 Pro1 후보 제외 (단, 다이버전스 조건 발동 시 예외)

### 10. 기술적 지표 사전 계산

- **daily_metrics 테이블**: MA20, MA60, RSI14, ROC12, Volatility20 지표 미리 계산 및 저장
- **빠른 조회**: 백테스트 및 추천 시 실시간 계산 없이 즉시 조회
- **데이터 동기화**: 가격 데이터 업데이트 시 지표 자동 재계산

### 11. Cron 기반 자동 데이터 업데이트

- **Vercel Cron Jobs**: 매일 미국 장 마감 후 자동으로 가격 데이터 및 기술적 지표 업데이트
- **전체 티커 자동 처리**: SOXL, TQQQ 등 지원 티커 전체를 순차적으로 업데이트
- **보안 인증**: `CRON_SECRET` 기반 Bearer 토큰 인증으로 무단 호출 방지
- **에러 리포팅**: 티커별 업데이트 결과(성공/실패/신규 레코드 수)를 JSON 응답으로 반환

### 12. 데이터 이관 (Local Supabase -> Cloud Supabase)

- **pg_dump/pg_restore 기반 이관**: 로컬 개발 환경의 Supabase 데이터를 클라우드로 안전하게 이관
- **셸 스크립트 자동화**: `scripts/migrate-to-cloud.sh` 실행으로 원클릭 데이터 이관
- **테이블 선택적 이관**: 가격 데이터, 기술적 지표, 추천 캐시 등 필요한 테이블만 선택 가능

---

## 사용 사례

### 사례 1: 신규 데이터베이스 구축

투자 분석을 시작하는 사용자가 SOXL의 전체 히스토리를 다운로드하여 로컬 데이터베이스를 구축합니다.

```bash
npm run dev init -- --ticker SOXL
```

**결과**: 2010년 3월 11일부터 현재까지 약 3,700개 이상의 일별 가격 데이터가 저장됩니다.

### 사례 2: 일일 데이터 업데이트

매일 장 마감 후 최신 데이터를 추가하여 데이터베이스를 최신 상태로 유지합니다.

```bash
npm run dev update-all
```

**결과**: 마지막 저장 날짜 이후의 새로운 데이터만 다운로드되어 효율적으로 업데이트됩니다.

### 사례 3: 특정 기간 데이터 분석

2024년 한 해의 TQQQ 가격 변동을 분석하기 위해 데이터를 조회합니다.

```bash
npm run dev query -- --ticker TQQQ --start 2024-01-01 --end 2024-12-31
```

**결과**: 해당 기간의 일별 시가, 고가, 저가, 종가, 거래량 데이터가 출력됩니다.

### 사례 4: 전체 티커 일괄 초기화

모든 지원 티커의 데이터를 한 번에 초기화합니다.

```bash
npm run dev init-all
```

**결과**: SOXL과 TQQQ 두 티커의 전체 히스토리가 순차적으로 다운로드됩니다.

### 사례 5: 웹 UI에서 전략 추천

웹 대시보드의 전략 추천 페이지에서 기준일을 선택하고 최적 전략을 확인합니다.

**결과**: 과거 유사 구간 분석을 통해 Pro1/Pro2/Pro3 중 최적 전략과 점수가 표시됩니다.

### 사례 6: 추천 백테스트 실행

웹 대시보드의 추천 백테스트 페이지에서 사이클별 동적 전략 적용 백테스트를 실행합니다.

**결과**: 각 사이클마다 추천된 전략을 적용하여 더 현실적인 백테스트 결과를 확인합니다.

---

## 주요 이점

| 이점 | 설명 |
|------|------|
| **클라우드 데이터 소유** | Supabase를 통해 어디서든 데이터 접근 가능 |
| **효율적인 업데이트** | 증분 업데이트로 네트워크 트래픽 최소화 |
| **확장 가능한 구조** | 새로운 티커 추가가 용이한 설정 기반 아키텍처 |
| **CLI/웹 자동화** | 스크립트, cron job, 웹 UI 모두 지원 |
| **데이터 안정성** | Drizzle ORM의 타입 안전한 쿼리와 트랜잭션으로 무결성 보장 |
| **AI 기반 추천** | 유사 구간 분석을 통한 최적 전략 추천 |

---

## 향후 로드맵

### 완료된 항목

- [x] 웹 대시보드 UI (Phase 1: Info/Backtest 페이지 UI 구현)
- [x] 백테스팅 엔진 구현 (Pro1/Pro2/Pro3 전략)
- [x] 백테스트 추천 기능 (AI 기반 자동 전략 추천)
- [x] Google OAuth 인증 시스템 구현
- [x] 마이페이지 및 회원 탈퇴 기능 구현
- [x] 트레이딩 계좌 관리 시스템 (PRD-TRADING-001)
  - 계좌 CRUD 및 티어 고정 방식 구현
  - 당일 주문 자동 생성 (LOC/MOC)
  - 티어별 보유현황 관리 및 주문 체결 처리
- [x] 전략 추천 엔진 (유사 구간 분석, 점수 계산)
- [x] 추천 백테스트 (사이클별 추천 전략 적용)
- [x] 기술적 지표 사전 계산 (daily_metrics 테이블)
- [x] 추천 캐시 (recommendation_cache 테이블)
- [x] Drizzle ORM + Supabase 마이그레이션
- [x] Vitest 테스트 프레임워크 도입
- [x] Vercel 배포 및 Cron 기반 자동 데이터 업데이트 (SPEC-DEPLOY-003)
- [x] Local Supabase -> Cloud Supabase 데이터 이관 스크립트

### 진행 예정 항목

- [ ] 매매 신호 생성 기능
- [ ] 수익률 분석 리포트
- [ ] 추가 티커 지원 (UPRO, SPXL 등)
- [ ] 최적화 엔진 (유전 알고리즘)

---

## 라이선스

MIT License

---

*마지막 업데이트: 2026년 2월*
